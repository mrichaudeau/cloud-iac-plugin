# Locals Configuration Template
# Generated by Cloud IaC Plugin
# Variables: {{provider}}, {{environment}}, {{project}}

locals {
  # ==============================================================================
  # NAMING
  # ==============================================================================

  # Standard prefix for all resources
  name_prefix = "${var.project}-${var.environment}"

  # Short prefix (for resources with length limits)
  short_prefix = "${substr(var.project, 0, 8)}${substr(var.environment, 0, 1)}"

  # ==============================================================================
  # COMMON TAGS
  # ==============================================================================

  common_tags = merge(
    {
      Project     = var.project
      Environment = var.environment
      ManagedBy   = "terraform"
      Owner       = var.owner
      CostCenter  = var.cost_center
{{#if provider == "aws"}}
      Region      = var.region
{{/if}}
{{#if provider == "azure"}}
      Location    = var.region
{{/if}}
{{#if provider == "gcp"}}
      Region      = var.region
{{/if}}
    },
    var.additional_tags
  )

  # ==============================================================================
  # ENVIRONMENT-SPECIFIC DEFAULTS
  # ==============================================================================

  env_config = {
    dev = {
      instance_size     = "small"
      az_count          = 2
      enable_multi_az   = false
      backup_retention  = 7
      log_retention     = 7
      deletion_protect  = false
    }
    staging = {
      instance_size     = "medium"
      az_count          = 2
      enable_multi_az   = false
      backup_retention  = 14
      log_retention     = 30
      deletion_protect  = false
    }
    prod = {
      instance_size     = "large"
      az_count          = 3
      enable_multi_az   = true
      backup_retention  = 30
      log_retention     = 90
      deletion_protect  = true
    }
  }

  # Current environment config
  current_env = local.env_config[var.environment]

  # ==============================================================================
  # NETWORKING
  # ==============================================================================

{{#if provider == "aws"}}
  # Get available AZs
  azs = slice(data.aws_availability_zones.available.names, 0, var.az_count)

  # Calculate subnets
  public_subnets = [
    for i, az in local.azs : cidrsubnet(var.vpc_cidr, 8, i)
  ]
  private_subnets = [
    for i, az in local.azs : cidrsubnet(var.vpc_cidr, 8, i + 10)
  ]
  database_subnets = [
    for i, az in local.azs : cidrsubnet(var.vpc_cidr, 8, i + 20)
  ]
{{/if}}

{{#if provider == "azure"}}
  # Azure location (use region if location not specified)
  location = coalesce(var.location, var.region)

  # Resource group name
  resource_group_name = "${local.name_prefix}-rg"

  # Calculate subnets
  public_subnets = [
    for i in range(var.az_count) : cidrsubnet(var.vpc_cidr, 8, i)
  ]
  private_subnets = [
    for i in range(var.az_count) : cidrsubnet(var.vpc_cidr, 8, i + 10)
  ]
  database_subnets = [
    for i in range(var.az_count) : cidrsubnet(var.vpc_cidr, 8, i + 20)
  ]
{{/if}}

{{#if provider == "gcp"}}
  # Default zone if not specified
  zone = coalesce(var.zone, "${var.region}-a")

  # Calculate subnets
  public_subnets = [
    for i in range(var.az_count) : cidrsubnet(var.vpc_cidr, 8, i)
  ]
  private_subnets = [
    for i in range(var.az_count) : cidrsubnet(var.vpc_cidr, 8, i + 10)
  ]
  database_subnets = [
    for i in range(var.az_count) : cidrsubnet(var.vpc_cidr, 8, i + 20)
  ]
{{/if}}

  # ==============================================================================
  # SECURITY
  # ==============================================================================

  # Sensitive ports that should never be exposed to 0.0.0.0/0
  sensitive_ports = [22, 23, 3389, 3306, 5432, 1433, 27017, 6379, 9200, 11211]

  # TLS configuration
  min_tls_version = "1.2"
{{#if provider == "aws"}}
  ssl_policy      = "ELBSecurityPolicy-TLS13-1-2-2021-06"
{{/if}}

  # ==============================================================================
  # GOVERNANCE
  # ==============================================================================

  # Budget alert thresholds (percentage)
  budget_thresholds = var.environment == "prod" ? [50, 80, 100, 120] : [80, 100]

  # Log retention based on environment
  log_retention_days = local.current_env.log_retention

  # Backup retention based on environment
  backup_retention_days = local.current_env.backup_retention
}

# ==============================================================================
# DATA SOURCES
# ==============================================================================

{{#if provider == "aws"}}
data "aws_availability_zones" "available" {
  state = "available"
}

data "aws_caller_identity" "current" {}

data "aws_region" "current" {}
{{/if}}

{{#if provider == "azure"}}
data "azurerm_client_config" "current" {}

data "azurerm_subscription" "current" {}
{{/if}}

{{#if provider == "gcp"}}
data "google_project" "current" {}

data "google_client_config" "current" {}
{{/if}}
