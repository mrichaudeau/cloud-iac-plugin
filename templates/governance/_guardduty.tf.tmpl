# GuardDuty Configuration Template
# Governance component - automatically injected for all environments
# Variables: {{project}}, {{environment}}, {{region}}

# ==============================================================================
# GUARDDUTY DETECTOR
# ==============================================================================

resource "aws_guardduty_detector" "main" {
  enable = true

  # Frequency of notifications
  finding_publishing_frequency = var.environment == "prod" ? "FIFTEEN_MINUTES" : "ONE_HOUR"

  # Enable additional data sources
  datasources {
    s3_logs {
      enable = true
    }

    kubernetes {
      audit_logs {
        enable = {{#if has_eks}}true{{else}}false{{/if}}
      }
    }

    malware_protection {
      scan_ec2_instance_with_findings {
        ebs_volumes {
          enable = var.environment == "prod"
        }
      }
    }
  }

  tags = merge(local.common_tags, {
    Name    = "${local.name_prefix}-guardduty"
    Purpose = "Threat detection"
  })
}

# ==============================================================================
# SNS TOPIC FOR ALERTS
# ==============================================================================

resource "aws_sns_topic" "guardduty_alerts" {
  name              = "${local.name_prefix}-guardduty-alerts"
  kms_master_key_id = module.kms.key_id

  tags = local.common_tags
}

resource "aws_sns_topic_policy" "guardduty_alerts" {
  arn    = aws_sns_topic.guardduty_alerts.arn
  policy = data.aws_iam_policy_document.guardduty_sns.json
}

data "aws_iam_policy_document" "guardduty_sns" {
  statement {
    effect = "Allow"

    principals {
      type        = "Service"
      identifiers = ["events.amazonaws.com"]
    }

    actions   = ["sns:Publish"]
    resources = [aws_sns_topic.guardduty_alerts.arn]
  }
}

# Email subscription (if budget_alert_emails is provided)
resource "aws_sns_topic_subscription" "guardduty_email" {
  count = length(var.budget_alert_emails) > 0 ? length(var.budget_alert_emails) : 0

  topic_arn = aws_sns_topic.guardduty_alerts.arn
  protocol  = "email"
  endpoint  = var.budget_alert_emails[count.index]
}

# ==============================================================================
# EVENTBRIDGE RULE FOR HIGH SEVERITY FINDINGS
# ==============================================================================

resource "aws_cloudwatch_event_rule" "guardduty_high_severity" {
  name        = "${local.name_prefix}-guardduty-high-severity"
  description = "Capture high severity GuardDuty findings"

  event_pattern = jsonencode({
    source      = ["aws.guardduty"]
    detail-type = ["GuardDuty Finding"]
    detail = {
      severity = [
        { numeric = [">=", 7] }  # High and Critical
      ]
    }
  })

  tags = local.common_tags
}

resource "aws_cloudwatch_event_target" "guardduty_sns" {
  rule      = aws_cloudwatch_event_rule.guardduty_high_severity.name
  target_id = "SendToSNS"
  arn       = aws_sns_topic.guardduty_alerts.arn

  input_transformer {
    input_paths = {
      severity    = "$.detail.severity"
      finding     = "$.detail.type"
      description = "$.detail.description"
      region      = "$.region"
      account     = "$.account"
    }

    input_template = <<EOF
{
  "alarm": "GuardDuty High Severity Finding",
  "severity": <severity>,
  "finding": "<finding>",
  "description": "<description>",
  "region": "<region>",
  "account": "<account>",
  "project": "${var.project}",
  "environment": "${var.environment}"
}
EOF
  }
}

# ==============================================================================
# CLOUDWATCH METRIC FILTER AND ALARM
# ==============================================================================

resource "aws_cloudwatch_log_metric_filter" "guardduty_findings" {
  name           = "${local.name_prefix}-guardduty-findings"
  pattern        = "{ $.detail.severity >= 4 }"
  log_group_name = "/aws/events/guardduty"

  metric_transformation {
    name          = "GuardDutyFindings"
    namespace     = "${var.project}/Security"
    value         = "1"
    default_value = "0"
  }
}

resource "aws_cloudwatch_metric_alarm" "guardduty_findings" {
  alarm_name          = "${local.name_prefix}-guardduty-findings"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  metric_name         = "GuardDutyFindings"
  namespace           = "${var.project}/Security"
  period              = 300
  statistic           = "Sum"
  threshold           = 0
  alarm_description   = "This alarm monitors GuardDuty findings"
  treat_missing_data  = "notBreaching"

  alarm_actions = [aws_sns_topic.guardduty_alerts.arn]
  ok_actions    = [aws_sns_topic.guardduty_alerts.arn]

  tags = local.common_tags
}

# ==============================================================================
# OUTPUTS
# ==============================================================================

output "guardduty_detector_id" {
  description = "GuardDuty detector ID"
  value       = aws_guardduty_detector.main.id
}

output "guardduty_alerts_topic_arn" {
  description = "SNS topic ARN for GuardDuty alerts"
  value       = aws_sns_topic.guardduty_alerts.arn
}
